# kits/web3/kit.yaml
suite:
  name: web3
  version: 0.1.0
  description: >
    Blockchain integration for COPF. Chain monitoring with
    finality-aware gating, IPFS content storage with pinning,
    and wallet-based authentication via signature verification.
    All domain logic in concepts + syncs — zero engine extensions.

concepts:
  ChainMonitor:
    spec: ./chain-monitor.concept
    params:
      B: { as: block-ref, description: "Reference to a tracked block" }

  Content:
    spec: ./content.concept
    params:
      C: { as: content-ref, description: "Reference to stored content (CID)" }

  Wallet:
    spec: ./wallet.concept
    params:
      W: { as: wallet-ref, description: "Reference to a wallet/address" }

syncs:
  required:
    - path: ./syncs/finality-gate.sync
      description: >
        Pattern sync for finality-aware gating. When a chain action
        completes, route through ChainMonitor/awaitFinality before
        triggering downstream cross-chain actions. Without this,
        reorgs cause permanent state inconsistency across chains.

  recommended:
    - path: ./syncs/reorg-compensation.sync
      name: ReorgCompensation
      description: >
        When ChainMonitor detects a reorg, flag downstream actions
        triggered by the reorged completion. Override with app-specific
        compensation logic (rollback, retry, alert).

    - path: ./syncs/content-pinning.sync
      name: ContentPinning
      description: >
        When Content/store completes, automatically pin the CID
        via the configured pinning service. Disable if managing
        pinning manually or using a dedicated pinning cron.

integrations:
  - kit: auth
    syncs:
      - path: ./syncs/wallet-auth.sync
        description: >
          Wire Wallet/verify into the auth kit's JWT flow.
          Wallet signature verification as an auth method.

infrastructure:
  transports:
    - name: evm
      path: ./infrastructure/transports/evm-transport.ts
      description: >
        EVM JSON-RPC transport adapter. Maps concept invoke() to
        contract calls via ethers.js/viem, query() to storage reads.
        Handles gas estimation, nonce management, receipt polling.
        Works for all EVM chains (Ethereum, Arbitrum, Optimism,
        Base, Polygon) — different RPC endpoints, same adapter.

    - name: starknet
      path: ./infrastructure/transports/starknet-transport.ts
      description: >
        StarkNet transport adapter for Cairo VM chains.
        Uses starknet.js for transaction submission and storage reads.

  storage:
    - name: ipfs
      path: ./infrastructure/storage/ipfs-storage.ts
      description: >
        IPFS content-addressed storage adapter. Maintains a mutable
        index (key → CID) on top of immutable content storage.
        Supports Pinata, web3.storage, and self-hosted IPFS nodes.

  deployTemplates:
    - path: ./infrastructure/deploy-templates/ethereum-mainnet.deploy.yaml
    - path: ./infrastructure/deploy-templates/arbitrum.deploy.yaml
    - path: ./infrastructure/deploy-templates/multi-chain.deploy.yaml

chainConfigs:
  ethereum:
    chainId: 1
    finality:
      type: confirmations
      threshold: 12
  arbitrum:
    chainId: 42161
    finality:
      type: l1-batch
      softFinality: sequencer
  optimism:
    chainId: 10
    finality:
      type: l1-batch
      softFinality: sequencer
  base:
    chainId: 8453
    finality:
      type: l1-batch
      softFinality: sequencer
  starknet:
    chainId: "SN_MAIN"
    finality:
      type: validity-proof
    transport: starknet

dependencies: []
