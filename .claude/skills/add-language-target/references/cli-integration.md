# CLI Integration Reference

## File to Modify

`cli/src/commands/generate.ts`

This is the only file you need to change to wire a new language target into the CLI.

## Current Structure

```typescript
import { typescriptGenHandler } from '../../../../handlers/ts/framework/typescript-gen.handler.js';
import { rustGenHandler } from '../../../../handlers/ts/framework/rust-gen.handler.js';

const SUPPORTED_TARGETS = ['typescript', 'rust'] as const;
type Target = (typeof SUPPORTED_TARGETS)[number];
```

The generator selection happens in the main loop:

```typescript
const generator =
  target === 'typescript' ? typescriptGenHandler : rustGenHandler;
```

## Three Changes Required

### 1. Add to SUPPORTED_TARGETS

```typescript
const SUPPORTED_TARGETS = ['typescript', 'rust', '<lang>'] as const;
```

### 2. Import the Handler

```typescript
import { <lang>GenHandler } from '../../../../handlers/ts/framework/<lang>-gen.handler.js';
```

### 3. Update Generator Selection

Change the ternary to a lookup or switch:

```typescript
const generators: Record<string, ConceptHandler> = {
  typescript: typescriptGenHandler,
  rust: rustGenHandler,
  '<lang>': <lang>GenHandler,
};

const generator = generators[target];
```

Or keep it simple with a ternary chain if preferred:

```typescript
const generator =
  target === 'typescript' ? typescriptGenHandler
  : target === 'rust' ? rustGenHandler
  : <lang>GenHandler;
```

## Output Directory Structure

Generated files go to `generated/<target>/`:

```
generated/
├── typescript/
│   ├── password.types.ts
│   ├── password.handler.ts
│   └── ...
├── rust/
│   ├── password/
│   │   ├── types.rs
│   │   └── ...
│   └── ...
└── <lang>/
    └── <files generated by your handler>
```

The generate command handles directory creation. Your handler just returns `{ path, content }` pairs. Paths can include subdirectories (e.g., `password/types.rs`) and the CLI will create them.

## Verification via Direct TypeScript Execution

Instead of running through the CLI binary, verify your generator works by executing TypeScript directly:

```bash
npx tsx -e "
import { readFileSync } from 'fs';
import { resolve } from 'path';
import { parseConceptFile } from './handlers/ts/framework/spec-parser.handler.js';
import { createInMemoryStorage } from './kernel/src/storage.js';
import { schemaGenHandler } from './handlers/ts/framework/schema-gen.handler.js';
import { <lang>GenHandler } from './handlers/ts/framework/<lang>-gen.handler.js';

// Parse a concept
const source = readFileSync('specs/app/password.concept', 'utf-8');
const ast = parseConceptFile(source);

// Generate manifest
const s1 = createInMemoryStorage();
const schemaResult = await schemaGenHandler.generate({ spec: 'test', ast }, s1);
if (schemaResult.variant !== 'ok') { console.error(schemaResult); process.exit(1); }

// Generate code
const s2 = createInMemoryStorage();
const result = await <lang>GenHandler.generate(
  { spec: 'test', manifest: schemaResult.manifest },
  s2,
);

if (result.variant !== 'ok') { console.error(result); process.exit(1); }

// Print generated files
for (const f of result.files) {
  console.log('=== ' + f.path + ' ===');
  console.log(f.content);
  console.log();
}
console.log(result.files.length + ' file(s) generated');
"
```

Then also verify the full pipeline via the CLI entry point:

```bash
npx tsx cli/src/index.ts generate --target <lang> --concept Password
```

This exercises the complete path: parse -> schema-gen -> your code-gen -> file writing.
