// =============================================================================
// Conduit App Widget Specification Types
//
// COIF-driven widget abstraction: each Conduit widget is described as a
// WidgetSpec that declares its concept bindings, element tree, anatomy,
// state machine, and accessibility contract. This spec is framework-agnostic —
// the same WidgetSpec renders via React, Vue, Svelte, Solid, Ink, or Vanilla
// through the COIF FrameworkAdapter pipeline.
//
// Architecture:
//   ConceptSpec → UISchema.inspect() → ElementTree
//   ElementTree + MachineSpec + Anatomy + A11ySpec = WidgetSpec
//   WidgetSpec  → FrameworkAdapter.normalize() → rendered component
// =============================================================================

// ---------------------------------------------------------------------------
// Element kinds — abstract interaction units from COIF Element concept
// ---------------------------------------------------------------------------

export type ElementKind =
  | 'input-text'
  | 'input-number'
  | 'input-date'
  | 'input-bool'
  | 'selection-single'
  | 'selection-multi'
  | 'trigger'
  | 'navigation'
  | 'output-text'
  | 'output-number'
  | 'output-date'
  | 'output-bool'
  | 'group'
  | 'container'
  | 'rich-text'
  | 'file-upload'
  | 'media-display';

// ---------------------------------------------------------------------------
// Element tree — the abstract UI structure generated by UISchema.inspect()
// ---------------------------------------------------------------------------

export interface ElementNode {
  readonly id: string;
  readonly kind: ElementKind;
  readonly label: string;
  readonly dataType: string;
  readonly required: boolean;
  readonly scope: string;              // JSON pointer into concept state: #/properties/title
  readonly constraints?: ElementConstraints;
  readonly children?: readonly ElementNode[];
}

export interface ElementConstraints {
  readonly min?: number;
  readonly max?: number;
  readonly minLength?: number;
  readonly maxLength?: number;
  readonly pattern?: string;
  readonly options?: readonly SelectionOption[];
}

export interface SelectionOption {
  readonly value: string;
  readonly label: string;
}

// ---------------------------------------------------------------------------
// Concept binding — which concept actions and state a widget connects to
// ---------------------------------------------------------------------------

export interface ConceptBinding {
  readonly concept: string;            // URI: "urn:copf/Article"
  readonly actions: readonly string[]; // actions this widget can invoke
  readonly queries: readonly string[]; // state relations this widget reads
}

// ---------------------------------------------------------------------------
// Anatomy — named parts contract (from COIF Anatomy concept)
// ---------------------------------------------------------------------------

export interface AnatomySpec {
  readonly component: string;          // e.g. "RegistrationForm"
  readonly parts: readonly string[];   // named structural parts
  readonly slots: readonly string[];   // insertion points for composition
}

// ---------------------------------------------------------------------------
// State machine — headless interaction logic (from COIF Widget/Machine)
// ---------------------------------------------------------------------------

export interface MachineState {
  readonly name: string;
  readonly on: Readonly<Record<string, MachineTransition>>;
}

export interface MachineTransition {
  readonly target: string;
  readonly guard?: string;
  readonly action?: string;
}

export interface MachineSpec {
  readonly initial: string;
  readonly states: Readonly<Record<string, MachineState>>;
  readonly context: Readonly<Record<string, unknown>>;
}

// ---------------------------------------------------------------------------
// Accessibility — ARIA + keyboard interactions (from COIF Widget a11ySpec)
// ---------------------------------------------------------------------------

export interface A11ySpec {
  readonly role: string;
  readonly label: string;
  readonly description?: string;
  readonly keyboard: Readonly<Record<string, string>>; // key → action
  readonly liveRegions?: readonly string[];             // parts with aria-live
}

// ---------------------------------------------------------------------------
// WidgetSpec — the complete, framework-agnostic widget definition
// ---------------------------------------------------------------------------

export interface WidgetSpec {
  readonly name: string;
  readonly version: string;
  readonly category: 'form' | 'display' | 'composite' | 'navigation';

  // Which concepts this widget binds to
  readonly concepts: readonly ConceptBinding[];

  // COIF Anatomy: named parts
  readonly anatomy: AnatomySpec;

  // COIF Element tree: abstract UI structure
  readonly elements: readonly ElementNode[];

  // COIF Machine: headless state machine
  readonly machine: MachineSpec;

  // COIF A11y: accessibility contract
  readonly a11y: A11ySpec;
}

// ---------------------------------------------------------------------------
// Widget instance — runtime state produced by machine + signals
// ---------------------------------------------------------------------------

export interface WidgetInstance<TContext = Record<string, unknown>> {
  readonly spec: WidgetSpec;
  state: string;
  context: TContext;
  transition(event: string, payload?: Record<string, unknown>): void;
  getProps(part: string): Record<string, unknown>;
  destroy(): void;
}

// ---------------------------------------------------------------------------
// Widget registry — collects all Conduit widgets
// ---------------------------------------------------------------------------

export interface WidgetRegistry {
  register(spec: WidgetSpec): void;
  get(name: string): WidgetSpec | undefined;
  list(category?: string): readonly WidgetSpec[];
  createInstance<T = Record<string, unknown>>(
    name: string,
    initialContext?: Partial<T>,
  ): WidgetInstance<T>;
}
