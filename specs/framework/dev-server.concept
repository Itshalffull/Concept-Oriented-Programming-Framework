@category("devtools")
@visibility("public")
@version(2)
concept DevServer [D] {

  purpose {
    Coordinate the local development server lifecycle: start,
    stop, and query status. File watching is delegated to
    Resource (change detection), recompilation is triggered by
    syncs (Resource changes â†’ generation pipeline), and output
    is written through Emitter (content-addressed writes).
  }

  state {
    sessions: set D
    port: D -> Int
    status: D -> String
    watchDirs: D -> list String
  }

  actions {
    action start(port: Int, watchDirs: list String) {
      description {
        Start the development server on the specified port.
        Registers watch directories with Resource for change
        detection. Recompilation is handled by syncs that
        react to Resource change events.
      }
      -> ok(session: D, port: Int, url: String) {
        Development server started. Resource is tracking
        the specified directories for changes.
      }
      -> portInUse(port: Int) {
        The specified port is already in use.
      }
    }

    action stop(session: D) {
      description {
        Stop a running development server session and
        unregister watched resources.
      }
      -> ok(session: D) {
        Server stopped cleanly.
      }
    }

    action status(session: D) {
      description {
        Check the current status of a development server session.
      }
      -> running(port: Int, uptime: Int, lastRecompile: String) {
        Server is running with current stats.
      }
      -> stopped() {
        Server is not running.
      }
    }
  }

  invariant {
    after start(port: 3000, watchDirs: ["./specs", "./syncs"])
      -> ok(session: d, port: 3000, url: "http://localhost:3000")
    then stop(session: d) -> ok(session: d)
  }
}
