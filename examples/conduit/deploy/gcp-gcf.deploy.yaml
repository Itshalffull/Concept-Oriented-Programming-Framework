# Conduit â€” Google Cloud Functions Deployment Manifest
#
# Fully serverless deployment on Cloud Functions with Firestore storage,
# Pub/Sub-based transport, GCP Secret Manager for secrets, and
# Terraform for infrastructure-as-code.
# Zero idle cost, event-driven auto-scaling.
#
# Usage:
#   clef deploy --manifest deploy/gcp-gcf.deploy.yaml

app:
  name: conduit
  version: "0.1.0"
  uri: urn:conduit

runtimes:
  gcf:
    type: GcfRuntime
    engine: true
    transport: pubsub
    storage: firestore
    secrets: gcp-sm
    iac: terraform
    config:
      projectId: "${GCP_PROJECT_ID}"
      region: "${GCP_REGION:-us-central1}"
      memory: 256MB
      timeout: 60
      runtime: nodejs22

  engine:
    type: GcfRuntime
    engine: true
    transport: pubsub
    storage: firestore
    secrets: gcp-sm
    config:
      projectId: "${GCP_PROJECT_ID}"
      region: "${GCP_REGION:-us-central1}"
      memory: 512MB
      timeout: 120
      actionLog: firestore

infrastructure:
  storage:
    firestore:
      type: firestore
      config:
        projectId: "${GCP_PROJECT_ID}"
        collectionPrefix: "conduit-${STAGE:-prod}"

  transports:
    pubsub:
      type: pubsub
      config:
        projectId: "${GCP_PROJECT_ID}"
        topicPrefix: "conduit-${STAGE:-prod}-"
        ackDeadlineSeconds: 60

  secrets:
    gcp-sm:
      type: gcp-secret-manager
      config:
        projectId: "${GCP_PROJECT_ID}"
        secretPrefix: "conduit-${STAGE:-prod}-"

  iac:
    terraform:
      type: terraform
      config:
        stateBucket: "${TF_STATE_BUCKET}"
        statePrefix: "conduit/${STAGE:-prod}"
        modulePath: deploy/gcp/gcf

concepts:
  User:
    spec: specs/app/user.concept
    implementations:
      - language: typescript
        path: handlers/ts/app/user.impl.ts
        runtime: gcf
        storage: firestore
        queryMode: lite
  Password:
    spec: specs/app/password.concept
    implementations:
      - language: typescript
        path: handlers/ts/app/password.impl.ts
        runtime: gcf
        storage: firestore
        queryMode: lite
  JWT:
    spec: specs/app/jwt.concept
    implementations:
      - language: typescript
        path: handlers/ts/app/jwt.impl.ts
        runtime: gcf
        storage: firestore
        queryMode: lite
  Profile:
    spec: specs/app/profile.concept
    implementations:
      - language: typescript
        path: handlers/ts/app/profile.impl.ts
        runtime: gcf
        storage: firestore
        queryMode: lite
  Article:
    spec: specs/app/article.concept
    implementations:
      - language: typescript
        path: handlers/ts/app/article.impl.ts
        runtime: gcf
        storage: firestore
        queryMode: lite
  Comment:
    spec: kits/content/comment.concept
    implementations:
      - language: typescript
        path: handlers/ts/app/comment.impl.ts
        runtime: gcf
        storage: firestore
        queryMode: lite
  Tag:
    spec: kits/classification/tag.concept
    implementations:
      - language: typescript
        path: handlers/ts/app/tag.impl.ts
        runtime: gcf
        storage: firestore
        queryMode: lite
  Favorite:
    spec: specs/app/favorite.concept
    implementations:
      - language: typescript
        path: handlers/ts/app/favorite.impl.ts
        runtime: gcf
        storage: firestore
        queryMode: lite
  Follow:
    spec: specs/app/follow.concept
    implementations:
      - language: typescript
        path: handlers/ts/app/follow.impl.ts
        runtime: gcf
        storage: firestore
        queryMode: lite
  Echo:
    spec: specs/app/echo.concept
    implementations:
      - language: typescript
        path: handlers/ts/app/echo.impl.ts
        runtime: gcf
        storage: firestore
        queryMode: lite

syncs:
  - path: syncs/app/registration.sync
    engine: engine
    annotations: [eager]
  - path: syncs/app/login.sync
    engine: engine
    annotations: [eager]
  - path: syncs/app/articles.sync
    engine: engine
    annotations: [eager]
  - path: syncs/app/comments.sync
    engine: engine
    annotations: [eager]
  - path: syncs/app/social.sync
    engine: engine
    annotations: [eager]
  - path: syncs/app/profile.sync
    engine: engine
    annotations: [eager]
  - path: syncs/app/echo.sync
    engine: engine
    annotations: [eager]
