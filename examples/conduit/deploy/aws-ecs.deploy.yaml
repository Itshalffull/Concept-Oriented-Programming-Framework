# Conduit â€” AWS ECS Fargate Deployment Manifest
#
# Managed container deployment on ECS Fargate with DynamoDB storage,
# HTTP-based transport, AWS Secrets Manager for secrets, and
# CloudFormation for infrastructure-as-code.
# Always-on engine with low-latency HTTP transport.
#
# Usage:
#   copf deploy --manifest deploy/aws-ecs.deploy.yaml

app:
  name: conduit
  version: "0.1.0"
  uri: urn:conduit

runtimes:
  ecs:
    type: EcsRuntime
    engine: true
    transport: http
    storage: dynamodb
    secrets: aws-sm
    iac: cloudformation
    config:
      region: "${AWS_REGION:-us-east-1}"
      cpu: 256
      memory: 512
      minInstances: 1
      maxInstances: 4
      stage: "${STAGE:-prod}"
      healthCheck:
        path: /health
        interval: 30

infrastructure:
  storage:
    dynamodb:
      type: dynamodb
      config:
        region: "${AWS_REGION:-us-east-1}"
        tablePrefix: "conduit-${STAGE:-prod}-"
        singleTable: true
        billingMode: PAY_PER_REQUEST

  transports:
    http:
      type: http
      config:
        engineUrl: "${ENGINE_URL:-http://localhost:3000}"
        timeout: 10000

  secrets:
    aws-sm:
      type: aws-secrets-manager
      config:
        region: "${AWS_REGION:-us-east-1}"
        secretPrefix: "conduit/${STAGE:-prod}/"

  iac:
    cloudformation:
      type: cloudformation
      config:
        stackName: "conduit-ecs-${STAGE:-prod}"
        templatePath: deploy/aws/ecs-template.yaml
        vpcId: "${VPC_ID}"
        subnetIds: "${SUBNET_IDS}"

concepts:
  User:
    spec: specs/app/user.concept
    implementations:
      - language: typescript
        path: implementations/typescript/app/user.impl.ts
        runtime: ecs
        storage: dynamodb
        queryMode: lite
  Password:
    spec: specs/app/password.concept
    implementations:
      - language: typescript
        path: implementations/typescript/app/password.impl.ts
        runtime: ecs
        storage: dynamodb
        queryMode: lite
  JWT:
    spec: specs/app/jwt.concept
    implementations:
      - language: typescript
        path: implementations/typescript/app/jwt.impl.ts
        runtime: ecs
        storage: dynamodb
        queryMode: lite
  Profile:
    spec: specs/app/profile.concept
    implementations:
      - language: typescript
        path: implementations/typescript/app/profile.impl.ts
        runtime: ecs
        storage: dynamodb
        queryMode: lite
  Article:
    spec: specs/app/article.concept
    implementations:
      - language: typescript
        path: implementations/typescript/app/article.impl.ts
        runtime: ecs
        storage: dynamodb
        queryMode: lite
  Comment:
    spec: kits/content/comment.concept
    implementations:
      - language: typescript
        path: implementations/typescript/app/comment.impl.ts
        runtime: ecs
        storage: dynamodb
        queryMode: lite
  Tag:
    spec: kits/classification/tag.concept
    implementations:
      - language: typescript
        path: implementations/typescript/app/tag.impl.ts
        runtime: ecs
        storage: dynamodb
        queryMode: lite
  Favorite:
    spec: specs/app/favorite.concept
    implementations:
      - language: typescript
        path: implementations/typescript/app/favorite.impl.ts
        runtime: ecs
        storage: dynamodb
        queryMode: lite
  Follow:
    spec: specs/app/follow.concept
    implementations:
      - language: typescript
        path: implementations/typescript/app/follow.impl.ts
        runtime: ecs
        storage: dynamodb
        queryMode: lite
  Echo:
    spec: specs/app/echo.concept
    implementations:
      - language: typescript
        path: implementations/typescript/app/echo.impl.ts
        runtime: ecs
        storage: dynamodb
        queryMode: lite

syncs:
  - path: syncs/app/registration.sync
    engine: engine
    annotations: [eager]
  - path: syncs/app/login.sync
    engine: engine
    annotations: [eager]
  - path: syncs/app/articles.sync
    engine: engine
    annotations: [eager]
  - path: syncs/app/comments.sync
    engine: engine
    annotations: [eager]
  - path: syncs/app/social.sync
    engine: engine
    annotations: [eager]
  - path: syncs/app/profile.sync
    engine: engine
    annotations: [eager]
  - path: syncs/app/echo.sync
    engine: engine
    annotations: [eager]
