# kits/deploy/kit.yaml
kit:
  name: deploy
  version: 0.1.0
  description: >
    Deployment orchestration for COPF applications. Provides
    deploy planning, progressive delivery, schema migrations,
    health verification, environment management, observability
    injection, and immutable artifact management. Uses the
    coordination + provider pattern for runtimes, secrets, and
    infrastructure-as-code.

concepts:
  # --- Orchestration Concepts ---
  DeployPlan:
    spec: ./concepts/deploy-plan.concept
    params:
      D: { as: deploy-plan-ref, description: "Reference to a deployment plan" }

  Rollout:
    spec: ./concepts/rollout.concept
    params:
      R: { as: rollout-ref, description: "Reference to a progressive rollout" }

  Migration:
    spec: ./concepts/migration.concept
    params:
      M: { as: migration-ref, description: "Reference to a schema migration" }

  Health:
    spec: ./concepts/health.concept
    params:
      H: { as: health-check-ref, description: "Reference to a health check result" }

  Env:
    spec: ./concepts/env.concept
    params:
      E: { as: environment-ref, description: "Reference to a deployment environment" }

  Telemetry:
    spec: ./concepts/telemetry.concept
    params:
      T: { as: telemetry-config-ref, description: "Reference to a telemetry configuration" }

  Artifact:
    spec: ./concepts/artifact.concept
    params:
      A: { as: artifact-ref, description: "Reference to an immutable build artifact" }

  # --- Coordination Concepts ---
  Runtime:
    spec: ./concepts/runtime.concept
    params:
      I: { as: runtime-instance-ref, description: "Reference to a deployed runtime instance" }

  Secret:
    spec: ./concepts/secret.concept
    params:
      S: { as: secret-ref, description: "Reference to a resolved secret" }

  IaC:
    spec: ./concepts/iac.concept
    params:
      R: { as: iac-resource-ref, description: "Reference to an infrastructure resource" }

  GitOps:
    spec: ./concepts/gitops.concept
    params:
      G: { as: gitops-manifest-ref, description: "Reference to a GitOps manifest" }

  # --- Runtime Provider Plugins (load what you need) ---
  LambdaRuntime:
    spec: ./concepts/providers/lambda-runtime.concept
    params:
      F: { as: lambda-function-ref, description: "Reference to an AWS Lambda function" }
    optional: true

  EcsRuntime:
    spec: ./concepts/providers/ecs-runtime.concept
    params:
      S: { as: ecs-service-ref, description: "Reference to an ECS Fargate service" }
    optional: true

  CloudRunRuntime:
    spec: ./concepts/providers/cloud-run-runtime.concept
    params:
      C: { as: cloud-run-service-ref, description: "Reference to a Cloud Run service" }
    optional: true

  GcfRuntime:
    spec: ./concepts/providers/gcf-runtime.concept
    params:
      G: { as: gcf-function-ref, description: "Reference to a Google Cloud Function" }
    optional: true

  CloudflareRuntime:
    spec: ./concepts/providers/cloudflare-runtime.concept
    params:
      W: { as: cloudflare-worker-ref, description: "Reference to a Cloudflare Worker" }
    optional: true

  VercelRuntime:
    spec: ./concepts/providers/vercel-runtime.concept
    params:
      V: { as: vercel-project-ref, description: "Reference to a Vercel project" }
    optional: true

  K8sRuntime:
    spec: ./concepts/providers/k8s-runtime.concept
    params:
      K: { as: k8s-deployment-ref, description: "Reference to a Kubernetes deployment" }
    optional: true

  DockerComposeRuntime:
    spec: ./concepts/providers/docker-compose-runtime.concept
    params:
      D: { as: docker-compose-service-ref, description: "Reference to a Docker Compose service" }
    optional: true

  LocalRuntime:
    spec: ./concepts/providers/local-runtime.concept
    params:
      L: { as: local-process-ref, description: "Reference to a local process" }
    optional: true

  # --- Secret Provider Plugins (load what you need) ---
  VaultProvider:
    spec: ./concepts/providers/vault-provider.concept
    params:
      V: { as: vault-connection-ref, description: "Reference to a Vault connection" }
    optional: true

  AwsSmProvider:
    spec: ./concepts/providers/aws-sm-provider.concept
    params:
      A: { as: aws-sm-secret-ref, description: "Reference to an AWS Secrets Manager secret" }
    optional: true

  GcpSmProvider:
    spec: ./concepts/providers/gcp-sm-provider.concept
    params:
      G: { as: gcp-sm-secret-ref, description: "Reference to a GCP Secret Manager secret" }
    optional: true

  EnvProvider:
    spec: ./concepts/providers/env-provider.concept
    params:
      E: { as: env-variable-ref, description: "Reference to an environment variable" }
    optional: true

  DotenvProvider:
    spec: ./concepts/providers/dotenv-provider.concept
    params:
      D: { as: dotenv-file-ref, description: "Reference to a .env file entry" }
    optional: true

  # --- IaC Provider Plugins (file-generating; synced with generation kit) ---
  PulumiProvider:
    spec: ./concepts/providers/pulumi-provider.concept
    params:
      P: { as: pulumi-stack-ref, description: "Reference to a Pulumi stack" }
    optional: true

  TerraformProvider:
    spec: ./concepts/providers/terraform-provider.concept
    params:
      T: { as: terraform-workspace-ref, description: "Reference to a Terraform workspace" }
    optional: true

  CloudFormationProvider:
    spec: ./concepts/providers/cloudformation-provider.concept
    params:
      C: { as: cfn-stack-ref, description: "Reference to a CloudFormation stack" }
    optional: true

  DockerComposeIacProvider:
    spec: ./concepts/providers/docker-compose-iac-provider.concept
    params:
      I: { as: compose-iac-ref, description: "Reference to a Docker Compose IaC file" }
    optional: true

  # --- GitOps Provider Plugins (file-generating; synced with generation kit) ---
  ArgoCDProvider:
    spec: ./concepts/providers/argocd-provider.concept
    params:
      A: { as: argocd-app-ref, description: "Reference to an ArgoCD application" }
    optional: true

  FluxProvider:
    spec: ./concepts/providers/flux-provider.concept
    params:
      F: { as: flux-kustomization-ref, description: "Reference to a Flux kustomization" }
    optional: true

syncs:
  required:
    - path: ./syncs/core/validate-before-execute.sync
      name: ValidateBeforeExecute
      description: >
        After a deploy plan is created, automatically validate
        before execution proceeds.

    - path: ./syncs/delivery/rollback-on-failure.sync
      name: RollbackOnFailure
      description: >
        When kit health check fails, abort the rollout.

    - path: ./syncs/delivery/rollback-plan-on-abort.sync
      name: RollbackPlanOnAbort
      description: >
        When rollout is aborted, trigger full deployment rollback.

  recommended:
    - path: ./syncs/core/execute-after-validation.sync
      name: ExecuteAfterValidation
      description: >
        When validation passes with no migration needed,
        build artifacts and proceed with execution.

    - path: ./syncs/core/migrate-before-execute.sync
      name: MigrateBeforeExecute
      description: >
        When validation detects migration needed, run
        migration before execution.

    - path: ./syncs/migration/expand-after-plan.sync
      name: ExpandAfterPlan
      description: >
        Expand schema after migration is planned.

    - path: ./syncs/migration/migrate-after-expand.sync
      name: MigrateAfterExpand
      description: >
        Migrate data after schema expansion completes.

    - path: ./syncs/migration/contract-after-migrate.sync
      name: ContractAfterMigrate
      description: >
        Contract old schema after data migration. Eventual
        because contraction can be deferred.

    - path: ./syncs/migration/deploy-after-migrate.sync
      name: DeployAfterMigrate
      description: >
        Proceed with deployment after data migration completes.

    - path: ./syncs/delivery/begin-rollout.sync
      name: BeginRollout
      description: >
        Begin progressive rollout after execution if strategy
        is not immediate.

    - path: ./syncs/delivery/health-check-after-step.sync
      name: HealthCheckAfterStep
      description: >
        Run health check after each rollout step.

    - path: ./syncs/delivery/advance-on-healthy.sync
      name: AdvanceOnHealthy
      description: >
        When health and rollout pass, run telemetry analysis.

    - path: ./syncs/delivery/advance-on-metrics.sync
      name: AdvanceOnMetrics
      description: >
        When telemetry analysis is healthy, advance rollout.

    - path: ./syncs/delivery/pause-on-bad-metrics.sync
      name: PauseOnBadMetrics
      description: >
        When telemetry analysis is unhealthy, pause rollout.

    - path: ./syncs/observability/marker-on-deploy-start.sync
      name: MarkerOnDeployStart
      description: >
        Emit telemetry marker when deployment starts.

    - path: ./syncs/observability/marker-on-deploy-complete.sync
      name: MarkerOnDeployComplete
      description: >
        Emit telemetry marker when rollout completes.

    - path: ./syncs/observability/marker-on-rollback.sync
      name: MarkerOnRollback
      description: >
        Emit telemetry marker when deployment rolls back.

    - path: ./syncs/promotion/resolve-before-promote.sync
      name: ResolveBeforePromote
      description: >
        Resolve target environment after promotion.

    - path: ./syncs/promotion/plan-after-promotion.sync
      name: PlanAfterPromotion
      description: >
        Create deploy plan after environment resolved.

  # --- Plugin Syncs (activate per loaded provider) ---
  integration:
    # ─── Runtime Plugin: LambdaRuntime ───
    - path: ./syncs/routing/route-to-lambda.sync
      name: RouteLambda
    - path: ./syncs/routing/route-lambda-deploy.sync
      name: RouteLambdaDeploy
    - path: ./syncs/routing/lambda-provision-complete.sync
      name: LambdaProvisionComplete

    # ─── Runtime Plugin: EcsRuntime ───
    - path: ./syncs/routing/route-to-ecs.sync
      name: RouteEcs

    # ─── Runtime Plugin: CloudRunRuntime ───
    - path: ./syncs/routing/route-to-cloud-run.sync
      name: RouteCloudRun

    # ─── Runtime Plugin: GcfRuntime ───
    - path: ./syncs/routing/route-to-gcf.sync
      name: RouteGcf

    # ─── Runtime Plugin: CloudflareRuntime ───
    - path: ./syncs/routing/route-to-cloudflare.sync
      name: RouteCloudflare

    # ─── Runtime Plugin: VercelRuntime ───
    - path: ./syncs/routing/route-to-vercel.sync
      name: RouteVercel

    # ─── Runtime Plugin: K8sRuntime ───
    - path: ./syncs/routing/route-to-k8s.sync
      name: RouteK8s

    # ─── Runtime Plugin: DockerComposeRuntime ───
    - path: ./syncs/routing/route-to-docker-compose.sync
      name: RouteDockerCompose

    # ─── Runtime Plugin: LocalRuntime ───
    - path: ./syncs/routing/route-to-local.sync
      name: RouteLocal

    # ─── Secret Plugin: VaultProvider ───
    - path: ./syncs/routing/route-to-vault.sync
      name: RouteVault
    - path: ./syncs/routing/vault-resolved.sync
      name: VaultResolved

    # ─── Secret Plugin: AwsSmProvider ───
    - path: ./syncs/routing/route-to-aws-sm.sync
      name: RouteAwsSm

    # ─── Secret Plugin: GcpSmProvider ───
    - path: ./syncs/routing/route-to-gcp-sm.sync
      name: RouteGcpSm

    # ─── Secret Plugin: EnvProvider ───
    - path: ./syncs/routing/route-to-env.sync
      name: RouteEnv

    # ─── Secret Plugin: DotenvProvider ───
    - path: ./syncs/routing/route-to-dotenv.sync
      name: RouteDotenv

    # ─── IaC Plugin: PulumiProvider ───
    # Generation syncs (cache-check → on-miss → emit → record-cache → observer)
    - path: ./syncs/generation/pulumi-cache-check.sync
      name: CheckCacheBeforePulumi
    - path: ./syncs/generation/pulumi-on-miss.sync
      name: PulumiOnCacheMiss
    - path: ./syncs/generation/pulumi-emit.sync
      name: EmitPulumiFiles
    - path: ./syncs/generation/pulumi-record-cache.sync
      name: RecordCachePulumi
    - path: ./syncs/generation/pulumi-observer.sync
      name: ObservePulumi
    # Apply/teardown routing (non-generation)
    - path: ./syncs/routing/route-pulumi-apply.sync
      name: RoutePulumiApply
    - path: ./syncs/routing/pulumi-apply-complete.sync
      name: PulumiApplyComplete

    # ─── IaC Plugin: TerraformProvider ───
    - path: ./syncs/generation/terraform-cache-check.sync
      name: CheckCacheBeforeTerraform
    - path: ./syncs/generation/terraform-on-miss.sync
      name: TerraformOnCacheMiss
    - path: ./syncs/generation/terraform-emit.sync
      name: EmitTerraformFiles
    - path: ./syncs/generation/terraform-record-cache.sync
      name: RecordCacheTerraform
    - path: ./syncs/generation/terraform-observer.sync
      name: ObserveTerraform

    # ─── IaC Plugin: CloudFormationProvider ───
    - path: ./syncs/generation/cloudformation-cache-check.sync
      name: CheckCacheBeforeCloudFormation
    - path: ./syncs/generation/cloudformation-on-miss.sync
      name: CloudFormationOnCacheMiss
    - path: ./syncs/generation/cloudformation-emit.sync
      name: EmitCloudFormationFiles
    - path: ./syncs/generation/cloudformation-record-cache.sync
      name: RecordCacheCloudFormation
    - path: ./syncs/generation/cloudformation-observer.sync
      name: ObserveCloudFormation

    # ─── IaC Plugin: DockerComposeIacProvider ───
    - path: ./syncs/generation/docker-compose-iac-cache-check.sync
      name: CheckCacheBeforeDockerComposeIac
    - path: ./syncs/generation/docker-compose-iac-on-miss.sync
      name: DockerComposeIacOnCacheMiss
    - path: ./syncs/generation/docker-compose-iac-emit.sync
      name: EmitDockerComposeIacFiles
    - path: ./syncs/generation/docker-compose-iac-record-cache.sync
      name: RecordCacheDockerComposeIac
    - path: ./syncs/generation/docker-compose-iac-observer.sync
      name: ObserveDockerComposeIac

    # ─── GitOps Plugin: ArgoCDProvider ───
    - path: ./syncs/generation/argocd-cache-check.sync
      name: CheckCacheBeforeArgoCD
    - path: ./syncs/generation/argocd-on-miss.sync
      name: ArgoCDOnCacheMiss
    - path: ./syncs/generation/argocd-emit.sync
      name: EmitArgoCDFiles
    - path: ./syncs/generation/argocd-record-cache.sync
      name: RecordCacheArgoCD
    - path: ./syncs/generation/argocd-observer.sync
      name: ObserveArgoCD

    # ─── GitOps Plugin: FluxProvider ───
    - path: ./syncs/generation/flux-cache-check.sync
      name: CheckCacheBeforeFlux
    - path: ./syncs/generation/flux-on-miss.sync
      name: FluxOnCacheMiss
    - path: ./syncs/generation/flux-emit.sync
      name: EmitFluxFiles
    - path: ./syncs/generation/flux-record-cache.sync
      name: RecordCacheFlux
    - path: ./syncs/generation/flux-observer.sync
      name: ObserveFlux

uses:
  - kit: generation
    concepts:
      - name: Emitter
      - name: BuildCache
      - name: GenerationPlan

dependencies: []
